#!/bin/python3
# Download the helper library from https://www.twilio.com/docs/python/install
#these imports for for twilio
import os
from twilio.rest import Client
account_sid = os.environ['TWILIO_ACCOUNT_SID']
auth_token = os.environ['TWILIO_AUTH_TOKEN']
mongo_auth = os.environ['MONGO_AUTH']
client = Client(account_sid, auth_token)

#these imports are for scheduler
from datetime import datetime
now = datetime.now()

#this is to make the wait time work for our loop
from time import sleep

#this is for the scheduling system, to calculate time to compare with the database.
import time

#these are for MondoDB Data API
import requests
import json
url = "https://us-east-1.aws.data.mongodb-api.com/app/data-rwjpr/endpoint/data/v1/action/find"


# while True:
#         print("test")
#         sleep(10)
#         #api call goes here
#         if (True):
#                 message = client.messages \
#                 .create(
#                         body='This is the ship that made the Kessel Run in fourteen parsecs?',
#                         #hidden for privacy
#                         from_='+1',
#                         to='+1'
#                 )

#                 print(message.sid)

#this is how we send our call to the user
# call = client.calls.create(
#         #this is hosted by twilio assets static hosting. 
#         url='https://telemagenta-goldfish-8538.twil.io/assets/quickEscape.mp3',
#         to='+1',
#         from_='+1'
#         )

# print(call.sid)
 
def pick_me_up(final_phone_number):
        call = client.calls.create(
                #this is hosted by twilio assets static hosting. 
                url='https://telemagenta-goldfish-8538.twil.io/assets/i_need_a_ride.mp3',
                to='+12024597238',
                from_='+18339023143'
                )
        message = client.messages \
        .create(
                body='My car broke down and I dont have roadside, you gotta come get me',
                #hidden for privacy
                from_='+18339023143',
                to='+12024597238'
        )
        print(message.sid)
        sleep(10)
        message = client.messages \
        .create(
                body='I dont have roadside assistance...',
                #hidden for privacy
                from_='+18339023143',
                to='+12024597238'
        )
        print(message.sid)
        sleep(10)
        message = client.messages \
        .create(
                body='I really need you...',
                #hidden for privacy
                from_='+18339023143',
                to='+12024597238'
        )
        print(message.sid)


def angry_dad(final_phone_number):
        call = client.calls.create(
                #this is hosted by twilio assets static hosting. 
                url='https://telemagenta-goldfish-8538.twil.io/assets/angry_dad.mp3',
                to='+12024597238',
                from_='+18339023143'
                )
        message = client.messages \
        .create(
                body='GET HOME RIGHT NOW.',
                #hidden for privacy
                from_='+18339023143',
                to='+12024597238'
        )
        print(message.sid)
        sleep(15)
        message = client.messages \
        .create(
                body='GET HOME NOW.',
                #hidden for privacy
                from_='+18339023143',
                to='+12024597238'
        )
        print(message.sid)
        sleep(10)
        message = client.messages \
        .create(
                body='YOU WONT DRIVE FOR A MONTH',
                #hidden for privacy
                from_='+18339023143',
                to='+12024597238'
        )
        print(message.sid)
 
# Task scheduling
# schedule.every(.3).minutes.do(pick_me_up(user_phone_number))





# Loop so that the scheduling task
# keeps on running all time.
while True:
    current_time = time.time()
    payload = json.dumps({
        "collection": "calls",
        "database": "quickexit",
        "dataSource": "quickexit",
    "sort": { "callTime": 1 }
    })
    headers = {
      'Content-Type': 'application/json',
      'Access-Control-Request-Headers': '*',
      'api-key': "DnwgdZXY6S4HkShKhNgvk07aSxeEBdLXQbVQly1aENTWKzqXQjdNybLzCBGS5N0m", 
    }


    response = requests.request("POST", url, headers=headers, data=payload)

    # print(response.json())
    for item  in response.json()["documents"]:
        print(item)
        print(item["phoneNumber"])
        print(item["callType"])
        print(item["callTime"])
        print(item["completed"])


        user_phone_number = item["phoneNumber"]
        user_call_type = item["callType"]
        user_call_time = item["callTime"]
        user_job_completed_status = item["completed"]
        if user_job_completed_status == "false":
                user_job_completed_status_final = True

        if user_call_type == "Pulled over friend" and user_job_completed_status_final == False and (current_time >= user_call_time + 180 or current_time <= user_call_time - 180):
                pick_me_up(user_phone_number)
                #put api call here changing the completion status
        
        if user_call_type == "Angry dad" and user_job_completed_status_final == False (current_time >= user_call_time + 180 or current_time <= user_call_time - 180):
              angry_dad(user_phone_number)
              #put api call here changing the completion status
        #make it execute calls every cycle if there is a call going out.
    #runs every 10 seconds on a loop
    time.sleep(10)
